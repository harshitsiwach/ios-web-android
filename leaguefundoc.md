# League.Fun Contest Functionality Documentation

## Overview

This document details the implementation of contest functionality in the League.Fun application, including smart contract interactions and database connectivity for team data storage.

## Contest Functionality

The main contest functionality is implemented on the homepage (`src/app/page.js`) and includes:

- Fetching active contests from the smart contract
- Displaying contests in a scrollable format (with marquee for overflow)
- Allowing users to select a contest and submit their team
- Managing the entire team selection and submission workflow

### Contest Display & Fetching

- **Contract Interaction**: The application uses a JSON-RPC provider to fetch contest data without requiring wallet connection
- **Data Source**: Active contests are fetched using `getActiveContestIds()` and `getContestDetails()` methods from the smart contract
- **Display**: Contest cards show contest name, prize pool, number of teams, and progress bar indicating how many teams have joined
- **Contract Address**: `0xa80700e570CE8652F001A23B77AC9353413525fC`
- **RPC Provider**: BSC Testnet endpoint (`https://data-seed-prebsc-1-s1.binance.org:8545/`)

### Contest Card Component

- Located at `src/components/ContestCard.js`
- Displays contest name, prize pool, number of teams left, and visual progress bar
- Uses different colors for the progress bar based on contest fill percentage (>70% is red)

### Contest Selection

- Managed by `ContestSelectionModal` component (`src/components/ContestSelectionModal.js`)
- Presents a modal with all available contests for user selection
- Triggers the team submission process once a contest is selected

## Smart Contract Interactions

### Contract Details
- **Address**: `0xa80700e570CE8652F001A23B77AC9353413525fC` (BSC Testnet)
- **ABI**: Located at `src/abi/abi.json`
- **Payment Token**: `0x9b024b63fe5cce41536a152eF3E34f282EAbc2B6` (ERC20 token)

### Smart Contract Functions Used

#### Reading Functions (No Wallet Required)
- `getActiveContestIds()`: Fetches IDs of active contests
- `getContestDetails(uint256 contestId)`: Retrieves detailed information about a specific contest
- `TEAM_SIZE()`: Gets the required team size (defaulting to 5 if not available)

#### Writing Functions (Wallet Required)
- `submitTeam(uint256 contestId, string[] playerIds, bool[] predictions, string captain, string viceCaptain)`: Submits a team to a specific contest
- `paymentTokenContract.approve()`: Approves the contract to spend tokens

#### Key Events
- `TeamSubmitted`: Emitted when a team is successfully submitted, containing user address, contest ID, and team ID

### Token Approval Process
1. The application checks the current allowance of the payment token for the contest contract
2. If allowance is insufficient, it approves the required amount (10 tokens by default)
3. This approval is necessary before submitting a team to the contest

### Team Submission Process
1. Validates wallet connection and network (ensures BSC Testnet)
2. Validates team composition (5 players, unique players, valid captain/vice-captain)
3. Performs token approval if needed
4. Calls `submitTeam` function on the smart contract
5. Waits for transaction confirmation
6. Extracts the team ID from the `TeamSubmitted` event

## Database Connectivity & Data Storage

### Database Setup
- **Database**: Supabase PostgreSQL
- **Client**: `@supabase/supabase-js` version 2.56.0+
- **Configuration**: Located at `src/utils/supabase.js`

### Environment Variables
- `NEXT_PUBLIC_SUPABASE_URL`: Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Anonymous API key

### Database Tables

#### `teams` Table
Stores overall team information for contests:

- `id`: Primary key (auto-generated by Supabase)
- `wallet_address`: User's wallet address who submitted the team
- `team_name`: Name given to the team by user
- `contest_id`: Contest ID from the smart contract
- `created_at`: Timestamp when team was created
- `updated_at`: Timestamp when team was last updated
- `transaction_hash`: Blockchain transaction hash of team submission
- `blockchain_confirmed`: Boolean indicating if submission was confirmed on blockchain
- `submission_type`: Type of submission (currently 'BLOCKCHAIN')
- `entry_fee_paid`: Boolean indicating if the entry fee was paid
- `captain_token_symbol`: Token symbol selected as captain (2x points)
- `vice_captain_token_symbol`: Token symbol selected as vice-captain (1.5x points)
- `team_id_from_contract`: Unique team ID returned from smart contract

#### `team_tokens` Table
Stores individual tokens in each team:

- `id`: Primary key (auto-generated by Supabase)
- `team_id`: Foreign key linking to the `teams` table
- `contest_id`: Contest ID to which the team belongs
- `token_symbol`: Token symbol (e.g., BTC, ETH)
- `token_name`: Token name (e.g., Bitcoin, Ethereum) 
- `token_price`: Token price at the time of team creation
- `price_change_percent`: Price change percentage at team creation
- `position`: Position in the team (1-5)
- `prediction`: User's prediction ('positive' or 'negative')
- `created_at`: Timestamp when token was added to team
- `logo_url`: URL of the token's logo
- `team_id_from_contract`: Team ID from the smart contract

#### `current_token_prices` Table
Stores current prices for scoring calculation:

- `token_symbol`: Unique token symbol
- `current_price`: Current market price
- `last_updated`: Timestamp of last price update

#### `system_metadata` Table
Stores system-wide metadata:

- `key`: Unique key (e.g., 'last_price_update')
- `value`: Value corresponding to the key
- `updated_at`: Timestamp of last update

### Data Flow for Team Submission

1. **Frontend Validation**: Team is validated in the browser (correct number of players, captain/vice-captain selected, etc.)
2. **Blockchain Submission**: Team is submitted to the smart contract with token approval
3. **Blockchain Confirmation**: Transaction is awaited and event data is parsed
4. **Database Insertion**: Team data is inserted into the `teams` table
5. **Team Token Insertion**: Individual tokens are inserted into the `team_tokens` table
6. **Confirmation**: User receives success notification with transaction hash

### Score Calculation

The application calculates team scores using:
- Initial token prices (stored when team is submitted)
- Current token prices (updated periodically)
- User's predictions for each token
- Captain/vice-captain multipliers:
  - Captain: 2x points
  - Vice-captain: 1.5x points

## API Endpoints

### `/api/tokens`
- Fetches current cryptocurrency prices from CoinGecko API
- Returns mock data as fallback if CoinGecko API fails
- Used for displaying current token values and calculating scores

### `/api/update-prices`
- **POST**: Updates current token prices in the database
- **GET**: Checks the last update time
- Used to refresh prices for score calculation
- Runs periodically to maintain current scores

## Scoring System

Scores are calculated using the `calculateScore` utility function:
- Compares token price at submission time with current price
- Considers whether user's prediction was correct (positive/negative price movement)
- Adds extra points for correct predictions
- Multiplies scores for captain (2x) and vice-captain (1.5x)

## Ranking System

The ranking functionality:
- Fetches all teams and their tokens from Supabase
- Gets current token prices
- Calculates total scores for each team
- Sorts teams by score in descending order
- Displays the leaderboard with rank, team name, wallet address, and score